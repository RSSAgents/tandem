name: PR Notification

on:
  pull_request_target:
    branches: [main, development]
    types: [opened, reopened, ready_for_review]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_REVIEWERS: ${{ join(github.event.pull_request.requested_reviewers.*.login, ', ') }}
          PR_LABELS: ${{ join(github.event.pull_request.labels.*.name, ', ') }}
          PR_HEAD: ${{ github.event.pull_request.head.ref }}
          PR_BASE: ${{ github.event.pull_request.base.ref }}
          PR_ADDITIONS: ${{ github.event.pull_request.additions }}
          PR_DELETIONS: ${{ github.event.pull_request.deletions }}
          PR_FILES: ${{ github.event.pull_request.changed_files }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_ACTION: ${{ github.event.action }}
        run: |
          if [ "$PR_ACTION" == "opened" ]; then
            EVENT="ğŸ†• <b>New PR</b>"
          elif [ "$PR_ACTION" == "reopened" ]; then
            EVENT="ğŸ”„ <b>PR Reopened</b>"
          else
            EVENT="ğŸ“ <b>Ready for Review</b>"
          fi
          
          [ -z "$PR_REVIEWERS" ] && PR_REVIEWERS="â€”"
          [ -z "$PR_LABELS" ] && PR_LABELS="â€”"
          
          TEXT="$EVENT
          
          â”œ ğŸ“ <b>Title:</b> $PR_TITLE
          â”œ ğŸ‘¤ <b>Author:</b> $PR_AUTHOR
          â”œ ğŸ‘¥ <b>Reviewers:</b> $PR_REVIEWERS
          â”œ ğŸ·ï¸ <b>Labels:</b> $PR_LABELS
          â”œ ğŸŒ¿ <b>Branch:</b> <code>$PR_HEAD</code> â†’ <code>$PR_BASE</code>
          â”” ğŸ“Š <b>Changes:</b> +$PR_ADDITIONS / -$PR_DELETIONS ($PR_FILES files)
          
          ğŸ”— <a href=\"$PR_URL\">Open PR</a>"

          jq -n \
            --arg chat_id "$TELEGRAM_CHAT_ID" \
            --argjson thread_id "$TELEGRAM_THREAD_ID" \
            --arg text "$TEXT" \
            '{chat_id: $chat_id, message_thread_id: $thread_id, text: $text, parse_mode: "HTML", disable_web_page_preview: true}' \
            | curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d @-
