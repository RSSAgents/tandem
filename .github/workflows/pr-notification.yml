name: PR Notification

on:
  pull_request_target:
    branches: [main, development]
    types: [opened, reopened, ready_for_review]

jobs:
  notify:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ID: ${{ secrets.TELEGRAM_THREAD_ID }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event.pull_request.user.login }}
          PR_REVIEWERS: ${{ join(github.event.pull_request.requested_reviewers.*.login, ', ') }}
          PR_LABELS: ${{ join(github.event.pull_request.labels.*.name, ', ') }}
          PR_HEAD: ${{ github.event.pull_request.head.ref }}
          PR_BASE: ${{ github.event.pull_request.base.ref }}
          PR_ADDITIONS: ${{ github.event.pull_request.additions }}
          PR_DELETIONS: ${{ github.event.pull_request.deletions }}
          PR_FILES: ${{ github.event.pull_request.changed_files }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_ACTION: ${{ github.event.action }}
        run: |
          if [ "$PR_ACTION" == "opened" ]; then
            EVENT="üÜï New PR"
          elif [ "$PR_ACTION" == "reopened" ]; then
            EVENT="üîÑ PR Reopened"
          else
            EVENT="üìù Ready for Review"
          fi
          
          [ -z "$PR_REVIEWERS" ] && PR_REVIEWERS="none"
          [ -z "$PR_LABELS" ] && PR_LABELS="none"
          
          TEXT="$EVENT
          
          üìù Title: $PR_TITLE
          üë§ Author: $PR_AUTHOR
          üë• Reviewers: $PR_REVIEWERS
          üè∑Ô∏è Labels: $PR_LABELS
          üåø Branch: $PR_HEAD ‚Üí $PR_BASE
          üìä Changes: +$PR_ADDITIONS / -$PR_DELETIONS | files: $PR_FILES
          
          üîó $PR_URL"

          jq -n \
            --arg chat_id "$TELEGRAM_CHAT_ID" \
            --argjson thread_id "$TELEGRAM_THREAD_ID" \
            --arg text "$TEXT" \
            '{chat_id: $chat_id, message_thread_id: $thread_id, text: $text, disable_web_page_preview: true}' \
            | curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d @-
